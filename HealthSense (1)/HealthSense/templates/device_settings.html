{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="mb-0">Device Settings</h1>
        <p class="text-muted">Configure and manage your health monitoring devices</p>
    </div>
</div>

<!-- Device Information -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-microchip me-2"></i>
            Device Information
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Device ID</th>
                            <td>HEALTH01</td>
                        </tr>
                        <tr>
                            <th>Device Type</th>
                            <td>Health Monitor v1.0</td>
                        </tr>
                        <tr>
                            <th>Connected Since</th>
                            <td>May 30, 2023 15:42</td>
                        </tr>
                        <tr>
                            <th>Status</th>
                            <td><span class="badge bg-success">Active</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Connection Type</th>
                            <td>HTTP/WiFi</td>
                        </tr>
                        <tr>
                            <th>Last Data Sent</th>
                            <td id="last-data-sent">--</td>
                        </tr>
                        <tr>
                            <th>Data Points Sent</th>
                            <td>127</td>
                        </tr>
                        <tr>
                            <th>Battery Level</th>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 78%;" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100">78%</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Device Simulator -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-tools me-2"></i>
            Device Simulator
        </h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <select class="form-select" id="simulator-device-id">
                        <option value="HEALTH01">HEALTH01</option>
                        <option value="HEALTH02">HEALTH02</option>
                        <option value="HEALTH03">HEALTH03</option>
                    </select>
                    <label for="simulator-device-id">Device ID</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <select class="form-select" id="simulator-scenario">
                        <option value="healthy">Healthy</option>
                        <option value="diabetes">Diabetes Simulation</option>
                        <option value="heart_issue">Heart Issue Simulation</option>
                        <option value="hypoxia">Hypoxia Simulation</option>
                        <option value="random">Random Readings</option>
                    </select>
                    <label for="simulator-scenario">Health Scenario</label>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <select class="form-select" id="simulator-interval">
                        <option value="5">5 seconds</option>
                        <option value="10">10 seconds</option>
                        <option value="30">30 seconds</option>
                        <option value="60">60 seconds</option>
                    </select>
                    <label for="simulator-interval">Update Interval</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <select class="form-select" id="simulator-duration">
                        <option value="0">Continuous</option>
                        <option value="60">1 minute</option>
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                        <option value="1800">30 minutes</option>
                    </select>
                    <label for="simulator-duration">Duration</label>
                </div>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">Run Instructions</div>
            <div class="card-body">
                <p>To run the simulator from your local machine, use the following command:</p>
                <div class="bg-dark text-light p-3 rounded">
                    <code id="simulator-command">python device_simulator.py --device-id HEALTH01 --server http://localhost:5000 --interval 5 --scenario healthy</code>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between">
            <button class="btn btn-primary" id="start-simulator-btn">
                <i class="fas fa-play me-2"></i>
                Start Simulator
            </button>
            <button class="btn btn-danger" id="stop-simulator-btn">
                <i class="fas fa-stop me-2"></i>
                Stop Simulator
            </button>
        </div>
    </div>
</div>

<!-- Sensor Calibration -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-sliders-h me-2"></i>
            Sensor Calibration
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="glucose-calibration" class="form-label">Glucose Sensor Calibration</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="glucose-calibration" value="0">
                    <span class="input-group-text">mg/dL offset</span>
                </div>
                <div class="form-text">Adjust if readings are consistently off by a fixed amount</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="bp-calibration" class="form-label">Blood Pressure Calibration</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="bp-calibration" value="0">
                    <span class="input-group-text">mmHg offset</span>
                </div>
                <div class="form-text">Applies to both systolic and diastolic readings</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="spo2-calibration" class="form-label">SpOâ‚‚ Sensor Calibration</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="spo2-calibration" value="0">
                    <span class="input-group-text">% offset</span>
                </div>
                <div class="form-text">Adjust for more accurate oxygen readings</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="heart-rate-calibration" class="form-label">Heart Rate Calibration</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="heart-rate-calibration" value="0">
                    <span class="input-group-text">BPM offset</span>
                </div>
                <div class="form-text">Adjust if readings differ from medical equipment</div>
            </div>
        </div>
        <button class="btn btn-primary" id="save-calibration-btn">
            <i class="fas fa-save me-2"></i>
            Save Calibration
        </button>
    </div>
</div>

<!-- Notification Settings -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-bell me-2"></i>
            Notification Settings
        </h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <h6>Alert Thresholds</h6>
                <div class="mb-3">
                    <label for="glucose-high" class="form-label">Glucose High Threshold</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="glucose-high" value="180">
                        <span class="input-group-text">mg/dL</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="glucose-low" class="form-label">Glucose Low Threshold</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="glucose-low" value="70">
                        <span class="input-group-text">mg/dL</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="bp-high" class="form-label">Blood Pressure High Threshold</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="bp-high" value="140">
                        <span class="input-group-text">mmHg systolic</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="spo2-low" class="form-label">SpOâ‚‚ Low Threshold</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="spo2-low" value="94">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6>Notification Methods</h6>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="notify-dashboard" checked>
                    <label class="form-check-label" for="notify-dashboard">
                        Dashboard Notifications
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="notify-email">
                    <label class="form-check-label" for="notify-email">
                        Email Notifications
                    </label>
                </div>
                <div class="mb-3">
                    <label for="email-address" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email-address" placeholder="your@email.com">
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="notify-sms">
                    <label class="form-check-label" for="notify-sms">
                        SMS Notifications
                    </label>
                </div>
                <div class="mb-3">
                    <label for="phone-number" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="phone-number" placeholder="+1234567890">
                </div>
            </div>
        </div>
        <button class="btn btn-primary" id="save-notifications-btn">
            <i class="fas fa-save me-2"></i>
            Save Notification Settings
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update last data sent time
    function updateLastDataSent() {
        document.getElementById('last-data-sent').textContent = new Date().toLocaleTimeString();
    }
    
    // Fetch latest data to get last update time
    fetch('/api/latest')
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('No data available');
        })
        .then(data => {
            if (data.status === 'success' && data.health_data) {
                const timestamp = new Date(data.health_data.timestamp);
                document.getElementById('last-data-sent').textContent = timestamp.toLocaleString();
            }
        })
        .catch(error => {
            console.error('Error fetching latest data:', error);
        });
    
    // Update simulator command when options change
    function updateSimulatorCommand() {
        const deviceId = document.getElementById('simulator-device-id').value;
        const scenario = document.getElementById('simulator-scenario').value;
        const interval = document.getElementById('simulator-interval').value;
        const duration = document.getElementById('simulator-duration').value;
        
        let command = `python device_simulator.py --device-id ${deviceId} --server http://localhost:5000 --interval ${interval} --scenario ${scenario}`;
        
        if (duration > 0) {
            command += ` --duration ${duration}`;
        }
        
        document.getElementById('simulator-command').textContent = command;
    }
    
    // Add event listeners to simulator options
    document.getElementById('simulator-device-id').addEventListener('change', updateSimulatorCommand);
    document.getElementById('simulator-scenario').addEventListener('change', updateSimulatorCommand);
    document.getElementById('simulator-interval').addEventListener('change', updateSimulatorCommand);
    document.getElementById('simulator-duration').addEventListener('change', updateSimulatorCommand);
    
    // Initialize command
    updateSimulatorCommand();
    
    // Mock functionality for simulator start/stop buttons
    document.getElementById('start-simulator-btn').addEventListener('click', function() {
        alert('In a real implementation, this would start the simulator on the server side.\n\nFor now, please run the device_simulator.py script manually using the command shown above.');
    });
    
    document.getElementById('stop-simulator-btn').addEventListener('click', function() {
        alert('Simulator would be stopped here.');
    });
    
    // Mock functionality for calibration save button
    document.getElementById('save-calibration-btn').addEventListener('click', function() {
        alert('Calibration settings saved successfully.');
    });
    
    // Mock functionality for notification settings save button
    document.getElementById('save-notifications-btn').addEventListener('click', function() {
        alert('Notification settings saved successfully.');
    });
});
</script>
{% endblock %}
